rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // ======================================================================
    // HELPER FUNCTIONS
    // ======================================================================

    function isAuth() { return request.auth != null; }
    function authedUid() { return request.auth.uid; }

    function isSuperAdmin() { return isAuth() && request.auth.token.isSuperAdmin == true; }
    function isFranchiseOwner() { return isAuth() && request.auth.token.isFranchiseOwner == true; }
    
    // Reads the main hotel document to check if the user is in the ownerUids list.
    function isListedOwner(hotelId) {
      return isAuth() && authedUid() in get(/databases/$(database)/documents/hotels/$(hotelId)).data.ownerUids;
    }
    
    // Checks the 'role' field from the user's team member document.
    function getUserRole(hotelId) {
        return get(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(authedUid())).data.role;
    }
    
    function hasTeamRole(hotelId, role) {
      return exists(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(authedUid())) && getUserRole(hotelId) == role;
    }
    
    function canViewFinancials(hotelId) {
       return isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin') || hasTeamRole(hotelId, 'Owner') || hasDelegatedAccess(hotelId) || isSuperAdmin();
    }
    
    function isHotelStaff(hotelId) {
       return exists(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(authedUid()));
    }
    
    function hasDelegatedAccess(hotelId) {
        return isFranchiseOwner() && exists(/databases/$(database)/documents/hotels/$(hotelId)/delegates/$(authedUid()));
    }
    
    function isGuestOfStay(stayId) {
        return stayId != null && exists(/databases/$(database)/documents/activeStays/$(stayId));
    }

    // ======================================================================
    // RULES
    // ======================================================================

    match /hotels/{hotelId} {
      allow read: if isHotelStaff(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
      allow create: if isAuth() && authedUid() == hotelId;
      allow update: if isListedOwner(hotelId) || isSuperAdmin();
      allow list: if isAuth();
    }
    
    match /hotels/{hotelId}/teamMembers/{memberId} {
      allow get: if (isAuth() && authedUid() == memberId) || isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
      allow list: if isHotelStaff(hotelId);
      allow write: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
    }

    match /hotels/{hotelId}/checkoutHistory/{docId} {
      allow read, list: if canViewFinancials(hotelId);
      allow write: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
    }

    match /hotels/{hotelId}/corporateClients/{docId} {
      allow read, list: if canViewFinancials(hotelId);
      allow write: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
    }
    
    match /hotels/{hotelId}/{collection}/{docId} where collection in ['inventory', 'vendors', 'stockMovements', 'departments', 'shifts', 'slaRules'] {
      allow read, list: if isHotelStaff(hotelId);
      allow write: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
    }

    match /hotels/{hotelId}/{collection}/{docId} where collection in ['roomCategories', 'restaurants', 'serviceCategories', 'serviceTimings', 'config', 'broadcasts', 'hotelServices'] {
        allow read: if true;
        allow write: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
    }

    match /activeStays/{stayId} {
      allow get: if true;
      allow write: if isListedOwner(getAfter(/databases/$(database)/documents/activeStays/$(stayId)).data.hotelId) || hasTeamRole(getAfter(/databases/$(database)/documents/activeStays/$(stayId)).data.hotelId, 'Admin');
      allow list: if isAuth();
    }

    match /hotels/{hotelId}/rooms/{roomId} {
        allow list: if isHotelStaff(hotelId);
        allow get: if isHotelStaff(hotelId) || isGuestOfStay(resource.data.stayId);
        allow create, delete: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
        allow update: if isHotelStaff(hotelId);
    }

    match /hotels/{hotelId}/serviceRequests/{reqId} {
        allow create: if isHotelStaff(hotelId) || isGuestOfStay(request.resource.data.stayId);
        allow get: if isHotelStaff(hotelId) || isGuestOfStay(resource.data.stayId);
        allow list: if isHotelStaff(hotelId) || (isGuestOfStay(request.query.where[2]) && request.query.where[0] == 'stayId');
        allow update, delete: if isHotelStaff(hotelId);
    }
    
    match /hotels/{hotelId}/accessRequests/{franchiseOwnerUid} { 
        allow create: if isFranchiseOwner() && authedUid() == franchiseOwnerUid; 
        allow read, list, delete: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
        allow update: if false; 
    }

    match /hotels/{hotelId}/delegates/{franchiseOwnerUid} {
      allow read: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin') || isFranchiseOwner();
      allow write: if isListedOwner(hotelId) || hasTeamRole(hotelId, 'Admin');
    }
  }
}
