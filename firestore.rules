rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // ======================================================================
    // SECURE & NON-RECURSIVE HELPER FUNCTIONS
    // ======================================================================
    
    function isTeamMember(hotelId) {
      // This is a safe, non-recursive check.
      return request.auth != null && exists(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(request.auth.uid));
    }
    
    function isHotelOwner(hotelId) {
      // This function can now safely use `get` because the read rule for /hotels/{hotelId} is non-recursive.
      let hotelData = get(/databases/$(database)/documents/hotels/$(hotelId)).data;
      return request.auth != null && hotelData.get('ownerUids', []).hasAny([request.auth.uid]);
    }

    function isHotelAdmin(hotelId) {
      // isHotelOwner check is now safe.
      let hasAdminRole = request.auth != null &&
                         exists(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(request.auth.uid)) &&
                         get(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(request.auth.uid)).data.role == 'Admin';
      return isHotelOwner(hotelId) || hasAdminRole;
    }

    function isFranchiseOwner() {
        return request.auth != null && request.auth.token.isFranchiseOwner == true;
    }

    function hasDelegatedAccess(hotelId) {
        return isFranchiseOwner() && exists(/databases/$(database)/documents/hotels/$(hotelId)/delegates/$(request.auth.uid));
    }
    
    function isDataOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.isSuperAdmin == true;
    }
    
    function isGuestOfStay(stayId) {
        // A guest is authenticated for a stay if their stayId exists in the public activeStays collection
        return stayId != null && exists(/databases/$(database)/documents/activeStays/$(stayId));
    }

    // ======================================================================
    // PUBLIC & USER-SPECIFIC ACCESS
    // ======================================================================

    match /activeStays/{stayId} {
      allow get: if true;
      // Admins manage this public collection during check-in/checkout
      allow write: if isHotelAdmin(getAfter(/databases/$(database)/documents/activeStays/$(stayId)).data.hotelId);
      allow list: if false; // No one should list all active stays
    }

    // ======================================================================
    // CORE HOTEL & TEAM MEMBER RULES (NON-RECURSIVE)
    // ======================================================================
    
    match /hotels/{hotelId} {
      // The `read` rule now explicitly checks if the requester is the owner of the hotel document.
      allow read: if isDataOwner(hotelId) || isTeamMember(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
      allow create: if isDataOwner(hotelId);
      allow update: if isHotelAdmin(hotelId) || isSuperAdmin();
      allow list: if isFranchiseOwner() || isSuperAdmin();
    }

    match /hotels/{hotelId}/teamMembers/{memberId} {
      // A member can read their own profile, an admin can read any profile in their hotel.
      allow get: if isDataOwner(memberId) || isHotelAdmin(hotelId);
      // Listing team members is a privileged operation.
      allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
      // Only admins can create, update, or delete team members.
      allow create, update, delete: if isHotelAdmin(hotelId);
    }
    
    // ======================================================================
    // GENERIC SUBCOLLECTION RULES
    // ======================================================================

    // --- Publicly Readable Data (with admin write) ---
    match /hotels/{hotelId}/{collection}/{docId} 
        where collection in ['roomCategories', 'hotelServices', 'restaurants', 'serviceCategories', 'serviceTimings', 'config', 'broadcasts'] {
        allow read: if true;
        allow write: if isHotelAdmin(hotelId);
    }

    // --- STAFF-ONLY & DELEGATED ACCESS COLLECTIONS ---
    match /hotels/{hotelId}/{collection}/{docId}
        where collection in ['checkoutHistory', 'departments', 'shifts', 'slaRules', 'corporateClients', 'inventory', 'vendors'] {
        // CRITICAL FIX: Added isDataOwner to grant access to the hotel owner.
        allow list, read: if isDataOwner(hotelId) || isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
        allow write: if isHotelAdmin(hotelId);
    }
    
    // --- Guest & Staff Shared Collections ---
    match /hotels/{hotelId}/rooms/{roomId} {
        allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
        // A guest can only get their own room doc. The stayId is validated against activeStays.
        allow get: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin() || isGuestOfStay(resource.data.stayId);
        allow create, delete: if isHotelAdmin(hotelId);
        // Allows cleaning staff etc. to update status without full admin rights
        allow update: if isTeamMember(hotelId);
    }

    match /hotels/{hotelId}/serviceRequests/{reqId} {
        // Guests can create requests; team members can create manual charges.
        allow create: if isTeamMember(hotelId) || isGuestOfStay(request.resource.data.stayId);
        // Guests can read their own requests; staff can read any.
        allow get: if isTeamMember(hotelId) || isGuestOfStay(resource.data.stayId);
        // Guests can list ONLY their own requests (via a where clause); staff can list all.
        allow list: if isTeamMember(hotelId) || (isGuestOfStay(request.query.where[2]) && request.query.where[0] == 'stayId');
        allow update, delete: if isTeamMember(hotelId);
    }

    match /hotels/{hotelId}/stockMovements/{movementId} {
        allow get, list, delete: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
        allow create, update: if isTeamMember(hotelId);
    }

    // --- Delegation-specific ---
    match /hotels/{hotelId}/accessRequests/{franchiseOwnerUid} { 
        allow create: if isFranchiseOwner() && request.auth.uid == franchiseOwnerUid; 
        allow read, delete, list: if isHotelAdmin(hotelId); 
        allow update: if false; 
    }

    match /hotels/{hotelId}/delegates/{franchiseOwnerUid} {
      allow read, write: if isHotelAdmin(hotelId);
    }
  }
}