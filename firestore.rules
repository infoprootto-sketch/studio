
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // ======================================================================
    // HELPER FUNCTIONS
    // ======================================================================
    
    function isHotelOwner(hotelId) {
      let isOwnerInArray = request.auth != null && get(/databases/$(database)/documents/hotels/$(hotelId)).data.get('ownerUids', []).hasAny([request.auth.uid]);
      return request.auth != null && (request.auth.uid == hotelId || isOwnerInArray);
    }

    function isHotelAdmin(hotelId) {
      // This is the master check for admin privileges.
      // This has been made non-recursive.
      let isOwner = isHotelOwner(hotelId);
      // To check if the requestor has an admin role, we read *their own* document.
      // This is safe because the rule for /teamMembers/{userId} get allows isDataOwner(userId).
      let hasAdminRole = request.auth != null &&
                         exists(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(request.auth.uid)) &&
                         get(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(request.auth.uid)).data.role == 'Admin';
      return isOwner || hasAdminRole;
    }

    function isTeamMember(hotelId) {
      return request.auth != null && exists(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(request.auth.uid));
    }
    
    function isFranchiseOwner() {
        return request.auth != null && request.auth.token.isFranchiseOwner == true;
    }

    function hasDelegatedAccess(hotelId) {
        return isFranchiseOwner() && exists(/databases/$(database)/documents/hotels/$(hotelId)/delegates/$(request.auth.uid));
    }

    function isOwnerOrTeamMember(hotelId) {
      return isHotelAdmin(hotelId); // Simplified to master admin check
    }
    
    function isDataOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.isSuperAdmin == true;
    }
    
    function isGuestOfRoom() {
      return resource.data.stayId != null && exists(/databases/$(database)/documents/activeStays/$(resource.data.stayId));
    }

    // ======================================================================
    // PUBLIC & USER-SPECIFIC ACCESS
    // ======================================================================

    match /activeStays/{stayId} {
      allow get: if true;
      allow create: if isHotelAdmin(get(/databases/$(database)/documents/activeStays/$(stayId)).data.hotelId);
      allow update: if isHotelAdmin(get(/databases/$(database)/documents/activeStays/$(stayId)).data.hotelId);
      allow delete: if isHotelAdmin(get(/databases/$(database)/documents/activeStays/$(stayId)).data.hotelId);
      allow list: if false;
    }

    // ======================================================================
    // HOTEL DATA ACCESS
    // ======================================================================
    
    match /hotels/{hotelId} {
      // CRITICAL FIX: The `read` rule for the hotel doc cannot call helpers that perform other reads.
      // The previous rule called isTeamMember, which did an `exists()` call, which had a rule that
      // eventually called back to read the hotel doc, creating a recursive loop.
      // This new rule is self-contained and breaks the loop.
      allow read: if request.auth.uid == hotelId ||
                     (request.auth != null && exists(/databases/$(database)/documents/hotels/$(hotelId)/teamMembers/$(request.auth.uid))) ||
                     hasDelegatedAccess(hotelId) || 
                     isSuperAdmin();
      allow create: if isDataOwner(hotelId);
      allow update: if isHotelAdmin(hotelId) || isSuperAdmin();
      allow list: if isSuperAdmin() || isFranchiseOwner();
    }
    
    // ======================================================================
    // SUBCOLLECTION RULES
    // ======================================================================

    // --- Access Control ---
    match /hotels/{hotelId}/delegates/{franchiseOwnerUid} { allow read, write: if isHotelAdmin(hotelId); }
    match /hotels/{hotelId}/accessRequests/{franchiseOwnerUid} { 
        allow create: if isFranchiseOwner() && request.auth.uid == franchiseOwnerUid; 
        allow read, delete, list: if isHotelAdmin(hotelId); 
        allow update: if false; 
    }
    
    // --- Publicly Readable Data (with admin write) ---
    match /hotels/{hotelId}/{collection}/{docId} 
        where collection in ['roomCategories', 'hotelServices', 'restaurants', 'serviceCategories', 'serviceTimings', 'config'] {
        allow read: if true;
        allow write: if isHotelAdmin(hotelId);
    }

    // --- Guest or Staff Access ---
    match /hotels/{hotelId}/rooms/{roomId} {
        allow read, list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin() || isGuestOfRoom();
        allow create, delete: if isHotelAdmin(hotelId);
        allow update: if isHotelAdmin(hotelId) || isTeamMember(hotelId);
    }
    match /hotels/{hotelId}/serviceRequests/{reqId} {
        allow create: if isHotelAdmin(hotelId) || isTeamMember(hotelId) || (request.auth == null && request.resource.data.stayId != null && exists(/databases/$(database)/documents/activeStays/$(request.resource.data.stayId)));
        allow read, list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin() || exists(/databases/$(database)/documents/activeStays/$(resource.data.stayId));
        allow update: if isHotelAdmin(hotelId) || isTeamMember(hotelId);
        allow delete: if isHotelAdmin(hotelId);
    }
    match /hotels/{hotelId}/broadcasts/{docId} { 
      allow read: if true; 
      allow write: if isHotelAdmin(hotelId); 
    }

    // --- STAFF-ONLY COLLECTIONS (Master Admin Rule) ---
    match /hotels/{hotelId}/checkoutHistory/{docId=**} {
      allow read, write: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
    }
    match /hotels/{hotelId}/teamMembers/{docId=**} {
      // CRITICAL FIX: The `get` rule can't cause recursion. An admin can read other member docs.
      // A member can only read their own.
      allow get: if isDataOwner(docId) || isHotelAdmin(hotelId);
      allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
      allow create, update, delete: if isHotelAdmin(hotelId);
    }
    match /hotels/{hotelId}/departments/{docId=**} {
      allow read, write: if isHotelAdmin(hotelId);
      allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
    }
    match /hotels/{hotelId}/shifts/{docId=**} {
      allow read, write: if isHotelAdmin(hotelId);
      allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
    }
    match /hotels/{hotelId}/slaRules/{docId=**} {
      allow read, write: if isHotelAdmin(hotelId);
      allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
    }
    match /hotels/{hotelId}/corporateClients/{docId=**} {
      allow read, write: if isHotelAdmin(hotelId);
      allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
    }
    match /hotels/{hotelId}/inventory/{docId=**} {
      allow read, write: if isHotelAdmin(hotelId);
      allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
    }
    match /hotels/{hotelId}/vendors/{docId=**} {
      allow read, write: if isHotelAdmin(hotelId);
      allow list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
    }
    match /hotels/{hotelId}/stockMovements/{docId=**} {
      allow create: if isHotelAdmin(hotelId) || isTeamMember(hotelId);
      allow read, list: if isHotelAdmin(hotelId) || hasDelegatedAccess(hotelId) || isSuperAdmin();
      allow update: if false;
      allow delete: if isHotelAdmin(hotelId);
    }
  }
}
